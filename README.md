# DeployGate Resource

[![Go Report Card](https://goreportcard.com/badge/github.com/YuukiARIA/concourse-deploygate-resource)](https://goreportcard.com/report/github.com/YuukiARIA/concourse-deploygate-resource)
[![Version](https://img.shields.io/github/tag/YuukiARIA/concourse-deploygate-resource.svg?color=blue)](https://github.com/YuukiARIA/concourse-deploygate-resource/releases)

This is a write-only resource that enables to upload IPA/APK packages to [DeployGate](https://deploygate.com/).

## Source Configuration

- `api_key` (string): __*Required.*__ API key of a member or a group.
- `owner` (string): __*Required.*__ User name or group name.

## Behaviour

### `check`: Check for new revisions of apps.

Gets *versions* of applications belonging to configured organization.

*Versions* are identified by following attributes:

- `platform`: Either `Android` or `iOS`.
- `package_name`: The unique identifier of the application sush as `com.company.appname`.
- `revision`: Number of revision on DeployGate.

### `in`: Get app metadata.

Gets the single app metadata specified by `platform` and `package_name` and emits the data to *metadata.json*.

Below is an example.

<details>
<summary>metadata.json</summary>

```json
{
  "name": "My App",
  "package_name": "com.mycompany.myapp",
  "labels": {},
  "os_name": "Android",
  "current_revision": 16,
  "url": "https://deploygate.com/organizations/MyOrg/platforms/Android/apps/com.mycompany.myapp",
  "icon_url": "...",
  "owner": {
    "type": "Organization",
    "name": "MyOrg",
    "description": "My organization",
    "url": "https://deploygate.com/organizations/MyOrg",
    "enterprise": {
      "type": "Enterprise",
      "name": "mycompanyspace",
      "display_name": "My Company",
      "url": "https://deploygate.com/enterprises/mycompanyspace",
      "icon_url": "..."
    }
  }
}
```
</details>

Note that currently there is no functionality to download applications themselves (IPA/APK files).

### `out`: Push an app to DeployGate.

Upload the app package specified by `file` to DeployGate.

#### Parameters

- `file` (string): __*Required.*__ Path to the `*.ipa` or `*.apk` file to upload.
- `message` (string): *Optional.* Description of the uploaded file.
- `message_file` (string): *Optional.* Path to a text file containing message.
  Use this instead of `message` to add a message dynamically generated by some tasks.
  If `message_file` is specified, `message` is ignored.
- `distribution_key` (string): *Optional.* Hash key of distribution page.
  If specified, updates distribution page.
- `distribution_name` (string): *Optional.* Name of distribution page to update.
  If not exists, new distribution page will be created with specified name.
- `release_note` (string): *Optional.* Message added to distribution page when updated.
- `disable_notify` (bool): *Optional.* If *true*, disables e-mail notification (iOS only).
- `visibility` (string): *Optional.* This is ignored when updating existing apps.

These parameters are corresponding to [DeployGate API](https://docs.deploygate.com/reference#upload).
For more exact information, please refer to this official document.

## Example Configuration

### Resource Configuration

```yaml
resource_types:
  - name: deploygate
    type: docker-image
    source:
      repository: yuukiaria/deploygate-resource

resources:
  - name: deploygate
    type: deploygate
    source:
      api_key: ((your-api-key))
      owner: mygroup
```

### Upload with a simple message

```yaml
jobs:
  - name: publish-to-deploygate
    plan:
      - task: build-apk
        file: ci/build-task # your build task that produces builds/myapp.apk
      - put: deploygate
        params:
          file: builds/myapp.apk
          message: This is a new release
```

### Upload with a generated message


```yaml
jobs:
  - name: publish-to-deploygate
    plan:
      - task: build-apk
        file: ci/tasks/build-task # your build task that produces builds/myapp.apk
      - task: create-message
        file: ci/tasks/create-message
      - put: deploygate
        params:
          file: builds/myapp.apk
          message_file: message/message.txt
```

## License

This sofware is released under the MIT License, see [LICENSE](https://github.com/YuukiARIA/concourse-deploygate-resource/blob/master/LICENSE).
